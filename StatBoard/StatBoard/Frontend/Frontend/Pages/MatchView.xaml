<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:components="clr-namespace:Frontend.Resources.Components"
             xmlns:converters="clr-namespace:Frontend.Resources"
             x:Class="Frontend.MatchView"
             x:Name="matchViewInstance"
             Title="Vista de Partido">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:ActionCountConverter x:Key="ActionCountConverter" />
            <converters:ActionCountMultiConverter x:Key="ActionCountMultiConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Título del partido -->
            <Label x:Name="lblMatchViewTitle" 
                   FontSize="24" 
                   FontAttributes="Bold" 
                   HorizontalOptions="Center" />

            <Label x:Name="lblTournament" 
                   FontSize="18" 
                   FontAttributes="Italic" 
                   HorizontalOptions="Center" 
                   TextColor="Gray" />

            <!-- Encabezado de equipos -->
            <Grid ColumnSpacing="10" Padding="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="2*" />
                    <ColumnDefinition Width="50" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="50" />
                    <ColumnDefinition Width="2*" />
                </Grid.ColumnDefinitions>

                <!-- Líneas horizontales -->
                <BoxView 
                    Grid.Row="0" 
                    Grid.ColumnSpan="6" 
                    HeightRequest="1" 
                    BackgroundColor="White"
                    VerticalOptions="Start"/>
                <BoxView 
                    Grid.Row="0" 
                    Grid.ColumnSpan="6" 
                    HeightRequest="1" 
                    BackgroundColor="White"
                    VerticalOptions="End"/>
                <BoxView 
                    Grid.Row="1"
                    Grid.ColumnSpan="6" 
                    HeightRequest="1" 
                    BackgroundColor="White"
                    VerticalOptions="Start"/>
                <BoxView 
                    Grid.Row="1" 
                    Grid.ColumnSpan="6" 
                    HeightRequest="1" 
                    BackgroundColor="White"
                    VerticalOptions="End"/>

                <!-- Líneas verticales -->
                <BoxView Grid.RowSpan="2" Grid.Column="0" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="1" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="2" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="3" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="4" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="5" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                
                <BoxView Grid.RowSpan="2" Grid.Column="0" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="1" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="2" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="3" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="4" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="5" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>

                <Label Grid.Column="0" 
                       x:Name="lblTeamLocal" 
                       FontSize="30"
                       FontAttributes="Bold" 
                       HorizontalOptions="Center" 
                       VerticalOptions="Center" />

                <Label Grid.Column="2" 
                       x:Name="lblScoreL"
                       FontAttributes="Bold" 
                       FontSize="40"
                       HorizontalOptions="Center" 
                       VerticalOptions="Center" />

                <Label Grid.Column="3" 
                       x:Name="lblScoreA"
                       FontAttributes="Bold"
                       FontSize="40"
                       HorizontalOptions="Center" 
                       VerticalOptions="Center" />

                <Label Grid.Column="5" 
                       x:Name="lblTeamAway" 
                       FontSize="30" 
                       FontAttributes="Bold" 
                       HorizontalOptions="Center" 
                       VerticalOptions="Center" />
            </Grid>

            <!-- Subtítulos de la tabla -->
            <Grid ColumnSpacing="10" Padding="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="1*" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="1*" />
                </Grid.ColumnDefinitions>

                <!-- Líneas horizontales -->
                <BoxView 
                    Grid.Row="0" 
                    Grid.ColumnSpan="6" 
                    HeightRequest="1" 
                    BackgroundColor="White" 
                    VerticalOptions="Start"/>
                <BoxView 
                    Grid.Row="0" 
                    Grid.ColumnSpan="6" 
                    HeightRequest="1" 
                    BackgroundColor="White" 
                    VerticalOptions="End"/>
                <BoxView 
                    Grid.Row="1" 
                    Grid.ColumnSpan="6" 
                    HeightRequest="1" 
                    BackgroundColor="White" 
                    VerticalOptions="Start"/>
                <BoxView 
                    Grid.Row="1" 
                    Grid.ColumnSpan="6" 
                    HeightRequest="1" 
                    BackgroundColor="White" 
                    VerticalOptions="End"/>

                <!-- Líneas verticales -->
                <BoxView Grid.RowSpan="2" Grid.Column="0" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="1" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="2" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="3" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="4" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="2" Grid.Column="5" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                
                <BoxView Grid.RowSpan="2" Grid.Column="0" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="1" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="2" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="3" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="4" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="2" Grid.Column="5" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                

                <Label 
                    Grid.Column="0" 
                    Text="N°"
                    FontAttributes="Bold" 
                    HorizontalOptions="Center" 
                    VerticalOptions="Center" />

                <Label 
                   Grid.Column="1" Text="Nombre Jugador Local" 
                   FontAttributes="Bold" 
                   HorizontalOptions="Center" 
                   VerticalOptions="Center" />

                <Picker 
                    x:Name="pckLocalActions"
                    Grid.Column="2" 
                    Title="Acción" 
                    HorizontalOptions="Center" 
                    VerticalOptions="Center" 
                    SelectedIndexChanged="OnLocalPickerSelectedIndexChanged">
                    <Picker.ItemsSource>
                        <x:Array Type="{x:Type x:String}">
                            <x:String>Gol</x:String>
                            <x:String>Atajada</x:String>
                            <x:String>Errada</x:String>
                            <x:String>Bloqueo</x:String>
                            <x:String>Robo</x:String>
                            <x:String>Perdida</x:String>
                            <x:String>Foul</x:String>
                        </x:Array>
                    </Picker.ItemsSource>
                </Picker>
                <Picker 
                    x:Name="pckAwayActions"
                    Grid.Column="3" 
                    Title="Acción" 
                    HorizontalOptions="Center"
                    VerticalOptions="Center"
                    SelectedIndexChanged="OnAwayPickerSelectedIndexChanged">
                    <Picker.ItemsSource>
                        <x:Array Type="{x:Type x:String}">
                            <x:String>Gol</x:String>
                            <x:String>Atajada</x:String>
                            <x:String>Errada</x:String>
                            <x:String>Bloqueo</x:String>
                            <x:String>Robo</x:String>
                            <x:String>Perdida</x:String>
                            <x:String>Foul</x:String>
                        </x:Array>
                    </Picker.ItemsSource>
                </Picker>

                <Label 
                    Grid.Column="4" Text="N°" 
                    FontAttributes="Bold" 
                    HorizontalOptions="Center" 
                    VerticalOptions="Center" />

                <Label 
                   Grid.Column="5" 
                   Text="Nombre Jugador Visitante" 
                   FontAttributes="Bold" 
                   HorizontalOptions="Center" 
                   VerticalOptions="Center" />
            </Grid>

            <!-- Filas dinámicas de jugadores -->
            <Grid ColumnSpacing="10" Padding="10">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="1*" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="100" />
                    <ColumnDefinition Width="1*" />
                </Grid.ColumnDefinitions>

                <!-- Líneas horizontales -->
                <BoxView Grid.Row="0" Grid.ColumnSpan="4" HeightRequest="1" BackgroundColor="White" VerticalOptions="Start"/>
                <BoxView Grid.Row="1" Grid.ColumnSpan="4" HeightRequest="1" BackgroundColor="White" VerticalOptions="Start"/>
                <BoxView Grid.Row="2" Grid.ColumnSpan="4" HeightRequest="1" BackgroundColor="White" VerticalOptions="Start"/>
                
                <BoxView Grid.Row="0" Grid.ColumnSpan="4" HeightRequest="1" BackgroundColor="White" VerticalOptions="End"/>
                <BoxView Grid.Row="1" Grid.ColumnSpan="4" HeightRequest="1" BackgroundColor="White" VerticalOptions="End"/>
                <BoxView Grid.Row="2" Grid.ColumnSpan="4" HeightRequest="1" BackgroundColor="White" VerticalOptions="End"/>
                

                <!-- Líneas verticales -->
                <BoxView Grid.RowSpan="3" Grid.Column="0" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="3" Grid.Column="1" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="3" Grid.Column="2" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>
                <BoxView Grid.RowSpan="3" Grid.Column="3" WidthRequest="1" BackgroundColor="White" HorizontalOptions="Start"/>

                <BoxView Grid.RowSpan="3" Grid.Column="0" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="3" Grid.Column="1" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="3" Grid.Column="2" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>
                <BoxView Grid.RowSpan="3" Grid.Column="3" WidthRequest="1" BackgroundColor="White" HorizontalOptions="End"/>

                <!-- Jugadores locales -->
                <StackLayout 
                    x:Name="PlayerListLocal" 
                    BindableLayout.ItemsSource="{Binding TeamLocalPlayers}"
                    Grid.Column="0"
                    HorizontalOptions="FillAndExpand" 
                    VerticalOptions="FillAndExpand">
                    <StackLayout.Triggers>
                        <DataTrigger TargetType="StackLayout" Binding="{Binding TeamLocalPlayers.Count}" Value="0">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </StackLayout.Triggers>
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <components:PlayerItemView 
                                MatchView="{Binding Source={x:Reference matchViewInstance}}" 
                                Player="{Binding .}" />
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>
                <!--Contador de endings de jugadores locales-->
                <StackLayout 
                    Spacing="20"
                    x:Name="stklListLocalEndings" 
                    BindableLayout.ItemsSource="{Binding TeamLocalPlayers}"
                    Grid.Column="1"
                    HorizontalOptions="Center"
                    VerticalOptions="Start"
                    Padding="0,10,0,0">
                    <StackLayout.Triggers>
                        <DataTrigger TargetType="StackLayout" Binding="{Binding TeamLocalPlayers.Count}" Value="0">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </StackLayout.Triggers>
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <!--<Label 
                                x:Name="lblEndingsLocalPlayer"
                                Text="{Binding Id, 
                                    Converter={StaticResource ActionCountConverter}, 
                                    ConverterParameter={Binding Source={x:Reference pckLocalActions}, 
                                                        Path=SelectedItem}}" 
                                VerticalOptions="Center" 
                                HorizontalOptions="Center"/>-->
                            <!--<Label 
                                Text="{Binding Source={x:Reference matchViewInstance}, 
                                        Path=LocalPlayerActionCounts[Id]}" 
                                VerticalOptions="Center" 
                                HorizontalOptions="Center"/>-->
                            <Label
                                TextColor="White"
                                HorizontalOptions="Center"
                                VerticalOptions="Center">
                                <Label.Text>
                                    <MultiBinding Converter="{StaticResource ActionCountMultiConverter}">
                                        <Binding Path="Id" />
                                        <Binding Path="LocalActionSelected" Source="{x:Reference matchViewInstance}" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>

                <!-- Mensaje de jugadores locales vacíos -->
                <StackLayout IsVisible="False"
                             Grid.Column="0"
                             HorizontalOptions="Center"
                             VerticalOptions="Center">
                    <StackLayout.Triggers>
                        <DataTrigger TargetType="StackLayout" Binding="{Binding TeamLocalPlayers.Count}" Value="0">
                            <Setter Property="IsVisible" Value="True" />
                        </DataTrigger>
                    </StackLayout.Triggers>
                    <Label x:Name="lblMessageLocalEmptyPlayers"
                           Text="No hay jugadores del equipo local cargados aún."
                           TextColor="Red" 
                           HorizontalOptions="Center"
                           VerticalOptions="Center"/>
                </StackLayout>

                <!--Contador de endings de jugadores visitantes-->
                <StackLayout 
                    x:Name="stklListAwayEndings" 
                    BindableLayout.ItemsSource="{Binding TeamAwayPlayers}"
                    Spacing="20"
                    Grid.Column="2"
                    HorizontalOptions="Center"
                    VerticalOptions="Start"
                    Padding="0,10,0,0">
                    <StackLayout.Triggers>
                        <DataTrigger TargetType="StackLayout" Binding="{Binding TeamAwayPlayers.Count}" Value="0">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </StackLayout.Triggers>
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Label
                                TextColor="White"
                                HorizontalOptions="Center"
                                VerticalOptions="Center">
                                <Label.Text>
                                    <MultiBinding Converter="{StaticResource ActionCountMultiConverter}">
                                        <Binding Path="Id" />
                                        <Binding Path="AwayActionSelected" Source="{x:Reference matchViewInstance}" />
                                    </MultiBinding>
                                </Label.Text>
                            </Label>
                        
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>
                <!-- Jugadores visitantes -->
                <StackLayout 
                    x:Name="PlayerListAway" 
                    BindableLayout.ItemsSource="{Binding TeamAwayPlayers}"
                    Grid.Column="3"
                    HorizontalOptions="FillAndExpand" 
                    VerticalOptions="FillAndExpand">
                    <StackLayout.Triggers>
                        <DataTrigger TargetType="StackLayout" Binding="{Binding TeamAwayPlayers.Count}" Value="0">
                            <Setter Property="IsVisible" Value="False" />
                        </DataTrigger>
                    </StackLayout.Triggers>
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <components:PlayerItemView 
                                MatchView="{Binding Source={x:Reference matchViewInstance}}" 
                                Player="{Binding .}" />
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>

                <!-- Mensaje de jugadores visitantes vacíos -->
                <StackLayout
                     IsVisible="False"
                     Grid.Column="3"
                     HorizontalOptions="Center"
                     VerticalOptions="Center">
                    <StackLayout.Triggers>
                        <DataTrigger TargetType="StackLayout" Binding="{Binding TeamAwayPlayers.Count}" Value="0">
                            <Setter Property="IsVisible" Value="True" />
                        </DataTrigger>
                    </StackLayout.Triggers>
                    <Label 
                       x:Name="lblMessageEmptyAwayPlayers"
                       Text="No hay jugadores del equipo visitante cargados aún."
                       TextColor="Red" 
                       HorizontalOptions="Center"
                       VerticalOptions="Center"/>
                </StackLayout>
            </Grid>

            <!-- Botones de acción -->
            <HorizontalStackLayout Spacing="10" Padding="10">
                <Button x:Name="btnAddPlayer"
                        Text="Agregar jugador"
                        BackgroundColor="Blue"
                        TextColor="White"
                        Margin="10"
                        Clicked="OnAddPlayer" />

                <Button x:Name="btnCancel"
                        Text="Cancelar"
                        BackgroundColor="Red"
                        TextColor="White"
                        Margin="10"
                        Clicked="OnCancel" />

                <Button x:Name="btnFinish"
                        Text="Finalizar"
                        BackgroundColor="Green"
                        TextColor="White"
                        Margin="10"
                        Clicked="OnFinish" />
            </HorizontalStackLayout>

        </VerticalStackLayout>
    </ScrollView>

</ContentPage>